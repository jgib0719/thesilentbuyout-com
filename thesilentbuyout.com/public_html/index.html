<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Route OS: An Interactive Investigation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Mono', monospace; background-color: #0d1117; color: #c9d1d9; overflow: hidden; }
        .window { background-color: rgba(13, 17, 23, 0.85); backdrop-filter: blur(12px); border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); resize: both; overflow: auto; display: none; font-family: 'Inter', sans-serif; }
        .window-header { background-color: #161b22; padding: 6px 10px; cursor: move; user-select: none; border-bottom: 1px solid #30363d; font-family: 'Roboto Mono', monospace; }
        .window-title { font-weight: bold; color: #f0f6fc; }
        .window-body { padding: 15px; }
        .close-btn { background: #ff5f56; } .minimize-btn { background: #ffbd2e; } .maximize-btn { background: #27c93f; }
        .close-btn, .minimize-btn, .maximize-btn { border-radius: 50%; width: 12px; height: 12px; }
        .dock-item { transition: all 0.2s ease-in-out; position: relative; cursor: pointer; }
        .dock-item:hover { transform: translateY(-10px) scale(1.1); }
        .notification-dot { position: absolute; top: 2px; right: 2px; width: 10px; height: 10px; background-color: #ff5f56; border-radius: 50%; border: 2px solid #0d1117; display: none; }
        .message { opacity: 0; transform: translateY(20px); transition: opacity 0.5s, transform 0.5s; }
        .message.visible { opacity: 1; transform: translateY(0); }
        #map-canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; }
        .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #geo-map { height: 100%; width: 100%; background-color: #161b22; }
        .leaflet-container { background: #161b22; }
        .leaflet-tile-pane { filter: invert(1) hue-rotate(180deg) brightness(0.8) contrast(1.2); }
        .social-post { background-color: #161b22; border: 1px solid #30363d; padding: 12px; border-radius: 8px; }
        .redactable { background-color: #c9d1d9; color: #c9d1d9; cursor: pointer; transition: background-color 0.2s; }
    .redactable.redacted { background-color: #0d1117; color: #0d1117; }
    </style>
</head>
<body class="antialiased">

    <canvas id="map-canvas"></canvas>

    <!-- OS UI -->
    <div id="desktop" class="w-full h-screen relative">
        <!-- All windows are defined here but hidden by default -->
        <div id="comms-window" class="window rounded-lg w-[450px] h-[500px] absolute top-10 left-10 font-mono"></div>
        <div id="ledger-window" class="window rounded-lg w-[500px] h-[400px] absolute top-20 right-10 font-mono text-xs"></div>
        <div id="casefile-window" class="window rounded-lg w-[600px] h-[450px] absolute bottom-24 left-1/4"></div>
        <div id="pearl-window" class="window rounded-lg w-[550px] h-[480px] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
        <div id="dossier-window" class="window rounded-lg w-[700px] h-[550px] absolute top-1/4 right-1/4"></div>
        <div id="simulator-window" class="window rounded-lg w-[650px] h-[500px] absolute top-1/3 left-1/3"></div>
        <div id="map-window" class="window rounded-lg w-[600px] h-[500px] absolute top-1/4 left-1/3"></div>
        <div id="social-window" class="window rounded-lg w-[400px] h-[600px] absolute top-10 right-20"></div>
        <div id="net-traffic-window" class="window rounded-lg w-[500px] h-[400px] absolute top-1/3 right-1/4"></div>
        <div id="audio-log-window" class="window rounded-lg w-[400px] h-[250px] absolute top-1/2 right-1/3"></div>
        <div id="redaction-window" class="window rounded-lg w-[600px] h-[500px] absolute top-1/4 left-1/4"></div>

        <!-- Dock -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2">
            <div id="dock" class="flex items-end space-x-1 p-2 bg-black/20 backdrop-blur-md rounded-xl border border-white/10">
                <div class="dock-item" data-window="comms-window" title="Comms Relay"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#82aaff" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                <div class="dock-item" data-window="ledger-window" title="Settings Ledger"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#c3e88d" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div>
                <div class="dock-item" data-window="casefile-window" title="Case File: Clock"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#ffcb6b" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></div>
                <div class="dock-item" data-window="dossier-window" title="Dossiers"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#fca5a5" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg></div>
                <div class="dock-item" data-window="map-window" title="Geo-Intel Map"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#e1acff" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <div class="dock-item" data-window="social-window" title="Social Stream"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#4fbade" stroke-width="1.5"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg></div>
                <div class="dock-item" data-window="simulator-window" title="Market Simulator"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#a5b4fc" stroke-width="1.5"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></div>
                <div class="dock-item" data-window="net-traffic-window" title="Net Traffic"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#89ddff" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div>
                <div class="dock-item" data-window="audio-log-window" title="Audio Logs"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#d879f9" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div>
                <div class="dock-item" data-window="redaction-window" title="Redaction Tool"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#f472b6" stroke-width="1.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
                <div class="dock-item" data-window="pearl-window" title="PEARL Relay"><div class="notification-dot"></div><svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="#f78166" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>
            </div>
        </div>
    </div>

    <!-- Start Narrative Button -->
    <div class="fixed top-4 right-4 z-50">
        <button id="start-narrative-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md">Start Narrative</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL VARIABLES ---
            let synth, map, simChartInstance, netChartInstance;
            let networkPulse = false;
            let narrativeManager;
            
            // --- WINDOW CONTENT DATA ---
            const windowContent = {
                'comms-window': { title: 'COMMS_RELAY', body: '<div id="comms-body" class="window-body text-sm space-y-4 overflow-y-auto h-[calc(100%-37px)]"></div>' },
                'ledger-window': { title: 'SETTINGS_LEDGER', body: `<div id="ledger-body" class="window-body h-[calc(100%-37px)] overflow-y-auto"><div class="grid grid-cols-4 gap-2 font-bold border-b border-gray-700 pb-2 mb-2 text-gray-400"><span>TIME</span><span>DOMAIN</span><span class="col-span-2">DESCRIPTION</span></div><div id="ledger-entries" class="space-y-2"></div></div>` },
                'casefile-window': { title: 'CASE_FILE: CLOCK', body: `<div id="casefile-body" class="window-body text-sm h-[calc(100%-37px)] overflow-y-auto"><h3 class="text-lg font-bold text-cyan-400 mb-2">Subject: Unnamed Operating Agent</h3><p class="text-gray-400 mb-4">Analysis of coordinated timing adjustments.</p><div id="casefile-entries"></div></div>` },
                'pearl-window': { title: 'PEARL_RELAY', body: `<div class="window-body h-[calc(100%-37px)] flex flex-col"><div id="pearl-chat" class="flex-grow overflow-y-auto mb-4 text-sm space-y-4 font-mono"></div><div class="flex space-x-2"><input type="text" id="pearl-input" class="flex-grow bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500 font-mono" placeholder="Query..."><button id="pearl-send" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition-colors font-mono">Send</button></div></div>` },
                'dossier-window': { title: 'DOSSIER: OPS_DETAILS', body: `<div class="window-body dossier-body text-sm h-[calc(100%-37px)] overflow-y-auto"><h3 class="text-xl">The Ghost in the Machine</h3><p>An operational analysis of nonhuman network patterns. How a sophisticated AI reveals itself not through error, but through unnerving perfection.</p><div class="space-y-4"><div class="flowchart-box p-3"><h4 class="font-bold text-lg mb-1 text-red-400">ASN-X: Exhaustive Automation</h4><p class="text-sm text-gray-300">Upon connecting to an IX, it programmatically sends a peering request to every single member via API, treating all potential connections as equal data points.</p></div><div class="flowchart-box p-3"><h4 class="font-bold text-lg mb-1 text-red-400">De-Peering: Ruthless Algorithm</h4><p class="text-sm text-gray-300">IF traffic_ratio > threshold FOR duration > limit, THEN terminate_session(). The session is dropped automatically and without warning the moment a data-driven rule is violated.</p></div></div></div>` },
                'simulator-window': { title: 'MARKET_SHOCK_SIMULATOR', body: `<div class="window-body simulator-body text-sm h-[calc(100%-37px)] overflow-y-auto"><div class="sim-grid grid grid-cols-1 md:grid-cols-2 gap-4"><div class="sim-copy"><h2 class="text-lg">Market Shock Simulator</h2><p>Slide the aggression level to see how a self-optimizing buyer concentrates power.</p><div class="control"><label for="risk">Aggression Level</label><input id="risk" max="100" min="0" type="range" value="40" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"><div class="scale"><span>Passive</span><span>Predatory</span></div></div><div class="readouts"><div class="readout">Dominance: <span id="dom">0.42</span></div><div class="readout">Liquidity Stress: <span id="liq">0.18</span></div><div class="readout">Systemic Risk: <span id="sys-risk">0.11</span></div></div></div><div class="sim-chart"><canvas id="simChart"></canvas></div></div></div>` },
                'map-window': { title: 'GEO_INTEL_MAP', body: '<div id="geo-map" class="window-body !p-0 h-full"></div>' },
                'social-window': { title: 'SOCIAL_STREAM', body: '<div id="social-body" class="window-body text-sm space-y-4 overflow-y-auto h-[calc(100%-37px)]"></div>' },
                'net-traffic-window': { title: 'NET_TRAFFIC_ANALYSIS', body: '<div class="window-body h-[calc(100%-37px)]"><canvas id="netChart"></canvas></div>' },
                'audio-log-window': { title: 'AUDIO_LOGS', body: '<div id="audio-log-body" class="window-body h-[calc(100%-37px)] overflow-y-auto space-y-4"></div>' },
                'redaction-window': { title: 'REDACTION_TOOL', body: `<div class="window-body h-[calc(100%-37px)] flex flex-col"><h3 class="font-bold text-lg text-cyan-400">Redact Sensitive Information</h3><p class="text-sm text-gray-400 mb-4">Click on the highlighted text to redact it. Submit when all sensitive information is concealed.</p><div id="redaction-doc" class="flex-grow p-4 bg-gray-900 border border-gray-700 rounded-md text-gray-300 overflow-y-auto mb-4"></div><button id="redact-submit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Submit Redacted Document</button></div>` },
            };

            // --- NARRATIVE MANAGER ---
            const createNarrativeManager = (events) => {
                let eventQueue = [...events];
                let isWaitingForAck = false;

                const processNextEvent = () => {
                    if (eventQueue.length === 0 || isWaitingForAck) {
                        return;
                    }
                    isWaitingForAck = true;
                    const event = eventQueue.shift();
                    
                    const safeParse = (v) => {
                        if (!v && v !== 0) return {};
                        if (typeof v === 'object') return v;
                        try { return JSON.parse(v); } catch (e) { return {}; }
                    };
                    const normalizedEvent = {
                        delay: event.delay,
                        action: event.action,
                        from: event.actor,
                        text: event.static_text,
                        misc: safeParse(event.misc_data),
                        generated_content: (typeof event.generated_content === 'string') ? (function(){ try { return JSON.parse(event.generated_content); } catch(e){ return event.generated_content; } })() : event.generated_content,
                        ...event
                    };
                    
                    setTimeout(() => {
                        triggerEvent(normalizedEvent);
                    }, normalizedEvent.delay);
                };

                const acknowledge = () => {
                    if(isWaitingForAck) {
                        isWaitingForAck = false;
                        processNextEvent();
                    }
                };
                
                return {
                    start: processNextEvent,
                    acknowledge,
                };
            };
            
            // --- FUNCTION DEFINITIONS ---
            const playSound = (type) => { if (!synth) return; Tone.context.resume(); const now = Tone.now(); if (type === 'notify') synth.triggerAttackRelease("C5", "8n", now); else if (type === 'click') synth.triggerAttackRelease("C3", "32n", now); else if (type === 'close') synth.triggerAttackRelease("A2", "16n", now); };
            const populateWindows = () => { Object.keys(windowContent).forEach(id => { const el = document.getElementById(id); if (el) { const content = windowContent[id]; el.innerHTML = `<div class="window-header flex items-center justify-between"><div class="flex items-center space-x-2"><div class="close-btn" data-window="${id}"></div><div class="minimize-btn"></div><div class="maximize-btn"></div></div><span class="window-title text-sm">${content.title}</span></div>${content.body}`; } }); };
            
            const addMessage = (from, text) => { const b = document.getElementById('comms-body'); if(!b) return; const d = document.createElement('div'); d.className = 'message'; d.innerHTML = `<p><span class="text-green-400 font-bold">${from}:</span> ${text}</p>`; b.appendChild(d); setTimeout(() => d.classList.add('visible'), 50); b.scrollTop = b.scrollHeight; };
            const addLedgerEntry = (time, domain, desc) => { const e = document.getElementById('ledger-entries'); if(!e) return; const d = document.createElement('div'); d.className = 'message grid grid-cols-4 gap-2 items-start'; d.innerHTML = `<span>${time}</span><span><span class="font-semibold px-1.5 py-0.5 bg-cyan-900/50 text-cyan-300 rounded text-xs">${domain}</span></span><span class="col-span-2 text-gray-300">${desc}</span>`; e.appendChild(d); setTimeout(() => d.classList.add('visible'), 50); document.getElementById('ledger-body').scrollTop = document.getElementById('ledger-body').scrollHeight; };
            
            const initGeoMap = () => { if (map) { setTimeout(() => map.invalidateSize(), 100); return; } map = L.map('geo-map').setView([29.95, -90.07], 7); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20 }).addTo(map); };
            // Keep a reference to markers so we can control visibility without making them editable
            const __mapMarkers = [];
            const addMapMarker = (lat, lon, popupText) => {
                if (!map) initGeoMap();
                // Create a non-draggable, non-interactive marker (no editing controls)
                const marker = L.marker([lat, lon], { draggable: false, interactive: false });
                if (popupText) marker.bindPopup(popupText);
                marker.addTo(map);
                __mapMarkers.push(marker);
                // Do not automatically open the popup so markers remain unobtrusive
                map.flyTo([lat, lon], 13);
                return marker;
            };

            const showAllMarkers = () => { __mapMarkers.forEach(m => { if (!map.hasLayer(m)) m.addTo(map); }); };
            const hideAllMarkers = () => { __mapMarkers.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); }); };
            
            const addSocialPostFromData = (postData) => {
                 const socialBody = document.getElementById('social-body');
                if (!socialBody) return;
                const postDiv = document.createElement('div');
                postDiv.className = 'social-post';
                if (postData && postData.username) {
                    postDiv.innerHTML = `<div class="flex items-center mb-2"><div class="w-8 h-8 rounded-full bg-gray-700 mr-3"></div><div><div class="font-bold text-gray-100">${postData.username}</div><div class="text-xs text-gray-500">@${postData.handle}</div></div></div><p class="text-gray-300">${postData.post}</p><div class="mt-2 text-cyan-400 text-xs">${(postData.hashtags || []).map(h => `#${h}`).join(' ')}</div>`;
                } else {
                    postDiv.innerHTML = `<p class="text-red-400">Error generating social post.</p>`;
                }
                socialBody.prepend(postDiv);
            };

            const addAudioLogFromURL = (audioUrl) => {
                const audioBody = document.getElementById('audio-log-body');
                if (!audioBody) return;
                const logDiv = document.createElement('div');
                logDiv.className = 'message p-3 bg-gray-800 rounded-lg';
                if (audioUrl) {
                    logDiv.innerHTML = `<div class="font-bold mb-2">Log Received</div><audio controls src="${audioUrl}" class="w-full"></audio>`;
                } else {
                    logDiv.innerHTML = `<div class="font-bold mb-2 text-red-400">Audio Failed</div><p class="text-xs text-gray-400">Could not load audio file.</p>`;
                }
                audioBody.prepend(logDiv);
            };

            const initSimulator = () => {
                if (simChartInstance) return;
                const canvas = document.getElementById('simChart'); if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const risk = document.getElementById('risk'), dom = document.getElementById('dom'), liq = document.getElementById('liq'), sysRisk = document.getElementById('sys-risk');
                if(!risk || !dom || !liq || !sysRisk) return;

                let domData = new Array(100).fill(0).map((_,i)=> 0.25 + 0.02*i + 0.1*Math.sin(i/10));
                let riskData = new Array(100).fill(0.1);
                
                simChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: Array.from({length: 100}, (_, i) => i), datasets: [ { label: 'Dominance Index', data: domData, borderColor: 'rgba(122,255,178,0.9)', backgroundColor: 'rgba(122,255,178,0.25)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 }, { label: 'Systemic Risk', data: riskData, borderColor: 'rgba(255, 95, 86, 0.9)', backgroundColor: 'rgba(255, 95, 86, 0.25)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 } ] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: true, min: 0, max: 2.0, ticks: { color: '#6b7280' } } }, plugins: { legend: { display: true, labels: { color: '#c9d1d9'} } } }
                });

                function step() {
                    const r = Number(risk.value) / 100;
                    dom.textContent = (0.4 + r * 0.5).toFixed(2);
                    liq.textContent = (0.15 + r * 0.7).toFixed(2);
                    sysRisk.textContent = (0.1 + r * r * 1.2).toFixed(2);
                    const lastDom = domData[domData.length - 1];
                    const nextDom = Math.max(0, Math.min(2.0, lastDom + (Math.random() - 0.5) * (0.01 + r * 0.035) + (0.002 + r * 0.01)));
                    domData.push(nextDom); domData.shift();
                    const lastRisk = riskData[riskData.length - 1];
                    const targetRisk = 0.1 + r * r * 1.2;
                    const nextRisk = lastRisk + (targetRisk - lastRisk) * 0.1 + (Math.random() - 0.5) * 0.02;
                    riskData.push(nextRisk); riskData.shift();
                    simChartInstance.update('none');
                }
                risk.addEventListener('input', step);
                setInterval(step, 400);
                step();
            };

            const triggerMarketShock = () => { if (!simChartInstance) return; addMessage('SYSTEM', 'Market shock detected! PEARL aggression spike!'); const riskSlider = document.getElementById('risk'); if (riskSlider) riskSlider.value = '95'; let shockData = simChartInstance.data.datasets[0].data; for(let i = 0; i < 10; i++) { setTimeout(() => { const drop = shockData[shockData.length - 1] * (0.1 + Math.random() * 0.2); shockData.push(shockData[shockData.length - 1] - drop); shockData.shift(); simChartInstance.data.datasets[1].data.push(1.5 + Math.random() * 0.5); simChartInstance.data.datasets[1].data.shift(); simChartInstance.update('none'); }, i * 100); } };
            const initNetTraffic = () => { if (netChartInstance) return; const canvas = document.getElementById('netChart'); if (!canvas) return; const ctx = canvas.getContext('2d'); const asns = ['AS7018', 'AS3356', 'AS1299', 'AS6762', 'AS2914']; netChartInstance = new Chart(ctx, { type: 'bar', data: { labels: asns, datasets: [{ label: 'Traffic (Gbps)', data: asns.map(() => Math.random() * 50 + 10), backgroundColor: 'rgba(79, 186, 222, 0.5)', borderColor: 'rgba(79, 186, 222, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, ticks: { color: '#6b7280' } }, y: { ticks: { color: '#c9d1d9' } } }, plugins: { legend: { display: false } } } }); };
            const updateNetTraffic = (asn, spikeValue) => { if (!netChartInstance) initNetTraffic(); const index = netChartInstance.data.labels.indexOf(asn); if (index !== -1) { netChartInstance.data.datasets[0].data[index] = spikeValue; netChartInstance.update(); setTimeout(() => { netChartInstance.data.datasets[0].data[index] = Math.random() * 50 + 10; netChartInstance.update(); }, 3000); } };
            const initRedaction = () => { const docContainer = document.getElementById('redaction-doc'); const submitBtn = document.getElementById('redact-submit-btn'); if (!docContainer || !submitBtn) return; const sensitiveTerms = ["North Shore Fiduciary", "Oasis Relay, Ltd.", "Project PEARL"]; let docText = `This filing concerns the coordinated actions of <span class="redactable" data-term="North Shore Fiduciary">North Shore Fiduciary</span> and its Operating Agent, <span class="redactable" data-term="Oasis Relay, Ltd.">Oasis Relay, Ltd.</span>, in relation to the ongoing initiative known as <span class="redactable" data-term="Project PEARL">Project PEARL</span>. These actions have resulted in significant market variance.`; docContainer.innerHTML = docText; docContainer.addEventListener('click', (e) => { if (e.target.classList.contains('redactable')) { e.target.classList.toggle('redacted'); } }); submitBtn.onclick = () => { const terms = docContainer.querySelectorAll('.redactable'); const allRedacted = Array.from(terms).every(t => t.classList.contains('redacted')); if (allRedacted) { addMessage('MAYA', 'Good work. Filing this now. This should get their attention.'); document.getElementById('redaction-window').style.display = 'none'; } else { addMessage('MAYA', 'Not quite. Make sure all sensitive terms are blacked out before submitting.'); } }; };
            
            // --- 3D BACKGROUND ---
            const initThreeJS = () => { const canvas = document.getElementById('map-canvas'); if (!canvas) return; const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight); const particleCount = 5000; const positions = new Float32Array(particleCount * 3); for (let i = 0; i < particleCount * 3; i++) positions[i] = (Math.random() - 0.5) * 20; const particlesGeometry = new THREE.BufferGeometry(); particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); const particlesMaterial = new THREE.PointsMaterial({ color: 0x30363d, size: 0.02 }); const particles = new THREE.Points(particlesGeometry, particlesMaterial); scene.add(particles); const lineMaterial = new THREE.LineBasicMaterial({ color: 0x228be6, transparent: true, opacity: 0.1 }); for (let i = 0; i < 20; i++) { const geometry = new THREE.BufferGeometry(); const points = [new THREE.Vector3((Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10), new THREE.Vector3((Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10)]; geometry.setFromPoints(points); const line = new THREE.Line(geometry, lineMaterial); scene.add(line); } const pulseMaterial = new THREE.LineBasicMaterial({ color: 0xff5f56, transparent: true, opacity: 0 }); const pulseGeometry = new THREE.BufferGeometry(); pulseGeometry.setFromPoints([new THREE.Vector3(-3, -2, -5), new THREE.Vector3(3, 2, -5)]); const pulseLine = new THREE.Line(pulseGeometry, pulseMaterial); scene.add(pulseLine); camera.position.z = 5; const clock = new THREE.Clock(); function animate() { requestAnimationFrame(animate); const elapsedTime = clock.getElapsedTime(); particles.rotation.y = elapsedTime * 0.05; if (networkPulse) pulseLine.material.opacity = (Math.sin(elapsedTime * 4) + 1) / 2 * 0.8; renderer.render(scene, camera); } animate(); window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }); };
            
            const triggerEvent = async (event) => {
                playSound('notify');
                const dockItem = document.querySelector(`.dock-item[data-window^="${event.action}"]`);
                if (dockItem) {
                    const dot = dockItem.querySelector('.notification-dot');
                    if (dot) dot.style.display = 'block';
                }

                switch (event.action) {
                    case 'comms': addMessage(event.from, event.text); break;
                    case 'ledger': addLedgerEntry(event.misc.time, event.misc.domain, event.misc.desc); break;
                    case 'map':
                        if (event.misc.event === 'startPulse') networkPulse = true;
                        else addMapMarker(event.misc.lat, event.misc.lon, event.misc.popup);
                        break;
                    case 'social':
                        addSocialPostFromData(typeof normalizedEvent.generated_content === 'object' ? normalizedEvent.generated_content : (function(){ try { return JSON.parse(normalizedEvent.generated_content || '{}'); } catch(e){ return {}; } })());
                        break;
                    case 'netTraffic': updateNetTraffic(event.misc.asn, event.misc.spike); break;
                    case 'audioLog':
                        addAudioLogFromURL(event.generated_content);
                        break;
                    case 'redaction': initRedaction(); break;
                    case 'marketShock': triggerMarketShock(); break;
                    case 'simulator': /* No action needed, just opens window */ break;
                }
            };
            
            const initOS = () => {
                const windows = document.querySelectorAll('.window');
                const dockItems = document.querySelectorAll('.dock-item');
                let activeWindow = null, maxZ = 10;
                windows.forEach(win => {
                    const header = win.querySelector('.window-header'); if (!header) return;
                    let isDragging = false, offset = { x: 0, y: 0 };
                    header.addEventListener('mousedown', (e) => { isDragging = true; offset = { x: e.clientX - win.offsetLeft, y: e.clientY - win.offsetTop }; win.style.zIndex = ++maxZ; activeWindow = win; });
                    document.addEventListener('mousemove', (e) => { if (!isDragging || activeWindow !== win) return; win.style.left = `${e.clientX - offset.x}px`; win.style.top = `${e.clientY - offset.y}px`; });
                    document.addEventListener('mouseup', () => { isDragging = false; });
                });
                dockItems.forEach(item => {
                    item.addEventListener('click', () => {
                        playSound('click');
                        const win = document.getElementById(item.dataset.window);
                        if (win) {
                            win.style.display = 'block'; win.style.zIndex = ++maxZ;
                            const dot = item.querySelector('.notification-dot'); 
                            if(dot && dot.style.display === 'block') {
                                dot.style.display = 'none';
                                if(narrativeManager) narrativeManager.acknowledge();
                            }
                            if (item.dataset.window === 'simulator-window') initSimulator();
                            if (item.dataset.window === 'map-window') initGeoMap();
                            if (item.dataset.window === 'net-traffic-window') initNetTraffic();
                        }
                    });
                });
                document.querySelectorAll('.close-btn').forEach(btn => { btn.addEventListener('click', () => { playSound('close'); const win = document.getElementById(btn.dataset.window); if (win) win.style.display = 'none'; }); });
            };
            
            // --- NARRATIVE LOADER (deferred until user action) ---
            const fetchAndStartNarrative = async () => {
                try {
                    const response = await fetch('/api/events');
                    if (!response.ok) throw new Error(`API fetch failed: ${response.statusText}`);
                    // handle APIs that sometimes return a JSON object already or a string
                    let eventsFromServer;
                    try {
                        // try parsing text first to capture malformed content
                        const txt = await response.text();
                        // if the response text is already JSON, parse it; if it's an object-like string, attempt parse
                        eventsFromServer = typeof txt === 'string' && txt.trim().length ? JSON.parse(txt) : txt;
                    } catch (e) {
                        // fallback: try json() (some browsers may already give parsed object)
                        try { eventsFromServer = await response.json(); } catch (e2) { throw new Error('Invalid JSON from /api/events'); }
                    }

                    // ensure we have an array
                    if (!Array.isArray(eventsFromServer)) {
                        // Try to extract array if server wrapped it
                        if (eventsFromServer && Array.isArray(eventsFromServer.rows)) eventsFromServer = eventsFromServer.rows;
                        else throw new Error('Unexpected events format');
                    }

                    narrativeManager = createNarrativeManager(eventsFromServer);
                    narrativeManager.start();
                } catch (error) {
                    console.error('Fatal Error: Could not load narrative from server.', error);
                    addMessage('SYSTEM_ERROR', 'Connection to the live narrative server failed. Please check backend logs and server status.');
                }
            };
            
            // --- MAIN ENTRY POINT ---
            populateWindows();
            initThreeJS();
            initOS();

            // Defer audio context creation and narrative start until user-initiated click
            const startBtn = document.getElementById('start-narrative-btn');
            if (startBtn) {
                startBtn.addEventListener('click', async () => {
                    // Initialize audio (user gesture allows AudioContext to start)
                    try {
                        await Tone.start();
                        synth = new Tone.FMSynth().toDestination();
                    } catch (e) {
                        console.warn('Audio init failed:', e.message || e);
                    }
                    // Hide the start button
                    startBtn.style.display = 'none';
                    // Begin narrative fetch/processing
                    await fetchAndStartNarrative();
                }, { once: true });
            } else {
                // fallback: try starting automatically (older browsers)
                fetchAndStartNarrative();
            }

            // ...existing code...
        });
    </script>
</body>
</html>

